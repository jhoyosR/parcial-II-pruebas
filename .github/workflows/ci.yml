name: Laravel Sail CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  laravel-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Composer dependencies
        run: composer install --no-progress --no-interaction --prefer-dist
        
      - name: Configure .env for Sail CI
        run: |
          cp .env.example .env
          sed -i '/DB_HOST=/c\DB_HOST=mysql' .env
          echo "APP_ENV=testing" >> .env
          echo "DB_DATABASE=testing" >> .env
          echo "DB_USERNAME=sail" >> .env
          echo "DB_PASSWORD=password" >> .env

      - name: Start Sail Services
        run: ./vendor/bin/sail up -d
        timeout-minutes: 5
        
      - name: Wait for services to be healthy
        run: |
          sleep 10 

      - name: Generate App Key and Run Migrations
        run: |
          ./vendor/bin/sail artisan key:generate
          ./vendor/bin/sail artisan migrate --force

      - name: PHPStan (Static Analysis)
        run: docker compose exec -u www-data laravel.test vendor/bin/phpstan analyse --memory-limit=1G

      - name: Run Unit Tests
        run: ./vendor/bin/sail artisan test --testsuite=Unit

      - name: Run Integration Tests
        run: ./vendor/bin/sail artisan test --testsuite=Feature

      - name: Run System Tests
        run: ./vendor/bin/sail artisan test --testsuite=System
        
      - name: Stop Sail Services
        if: always()
        run: ./vendor/bin/sail down

      - name: ALL OK
        if: success()
        run: echo "Pipeline Completed Successfully!"
        
      - name: FAILED
        if: failure()
        run: echo "Pipeline Failed!"